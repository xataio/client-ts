name: Update Homebrew Formula

on:
  workflow_call:
    inputs:
      commit_sha:
        description: 'Commit SHA'
        required: true
        type: string
      version:
        description: 'Latest version'
        required: true
        type: string
      mac_intel_sha:
        description: 'Mac Intel SHA'
        required: true
        type: string
      mac_arm_sha:
        description: 'Mac ARM SHA'
        required: true
        type: string
      linux_sha:
        description: 'Linux SHA'
        required: true
        type: string
      linux_arm_sha:
        description: 'Linux ARM SHA'
        required: true
        type: string

jobs:
  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
        with:
          repository: xataio/homebrew-brew
          ref: 'main'
          token: ${{ secrets.ACTIONS_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: setup git config
        run: |
          git config user.name "Xata"
          git config user.email "<>"

      - name: Read template file
        id: gettemplate
        run: echo "::set-output name=template::$(cat ./Template/xata.rb)"

      - name: Update Homebrew Formula using template variables
        run: |
          echo "${{ steps.gettemplate.outputs.template }}" > ./Formula/xata.rb
          sed -i 's/__CLI_VERSION__/${{ inputs.version }}/g' ./Formula/xata.rb
          sed -i 's/__CLI_MAC_INTEL_SHA256__/${{ inputs.mac_intel_sha }}/g' ./Formula/xata.rb
          sed -i 's/__CLI_MAC_ARM_SHA256__/${{ inputs.mac_arm_sha }}/g' ./Formula/xata.rb
          sed -i 's/__CLI_LINUX_SHA256__/${{ inputs.linux_sha }}/g' ./Formula/xata.rb
          sed -i 's/__CLI_LINUX_ARM_SHA256__/${{ inputs.linux_arm_sha }}/g' ./Formula/xata.rb
          # todo fill in next correctly
          sed -i 's/__CLI_MAC_INTEL_DOWNLOAD_URL__/${{ secrets.CLI_MAC_INTEL_DOWNLOAD_URL }}/g' ./Formula/xata.rb
          sed -i 's/__CLI_MAC_ARM_DOWNLOAD_URL__/${{ secrets.CLI_MAC_INTEL_DOWNLOAD_URL }}/g' ./Formula/xata.rb
          sed -i 's/__CLI_LINUX_DOWNLOAD_URL__/${{ secrets.CLI_MAC_INTEL_DOWNLOAD_URL }}/g' ./Formula/xata.rb
          sed -i 's/__CLI_LINUX_ARM_DOWNLOAD_URL__/${{ secrets.CLI_MAC_INTEL_DOWNLOAD_URL }}/g' ./Formula/xata.rb

    # - name: commit changes
    #     run: |
    #       git add .
    #       git commit -m "Update Homebrew Formula"
    #       git push origin main
